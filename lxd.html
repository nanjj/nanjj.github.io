<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-11-26 äºŒ 00:40 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LXD</title>
<meta name="generator" content="Org mode" />
<link rel="stylesheet" type="text/css" href="css/org.css" />
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="theindex.html"> INDEX </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content">
<header>
<h1 class="title">LXD</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga9e8f4c">LXD Setup</a>
<ul>
<li><a href="#org86bdc9c">Deb or Snap</a></li>
<li><a href="#org4e171dc">Init</a></li>
</ul>
</li>
<li><a href="#orgb2025f0">Snap and Lxd</a>
<ul>
<li><a href="#orga8f5ead">Run lxd in Snap</a></li>
<li><a href="#org7b763fc">Launcn Lxd container</a></li>
<li><a href="#orgd2d6fae">Run snap inside Lxd Container</a></li>
<li><a href="#orgeee63fa">Run Lxd inside Lxd Container</a></li>
<li><a href="#org8f0f001">Run Docker inside Lxd Container</a></li>
<li><a href="#orgf423aad">Use Lxd Container as a Router</a></li>
</ul>
</li>
<li><a href="#org88e8934">Clustering Mode</a>
<ul>
<li><a href="#orgdd3ac39">New Cluster</a></li>
<li><a href="#org1e4a9c7">Join Cluster</a></li>
<li><a href="#orgbe53a27">List Cluster</a></li>
</ul>
</li>
<li><a href="#orgba57208">Database</a>
<ul>
<li><a href="#org410e40c">Global and Local</a></li>
<li><a href="#orgfe40e8d">Lxd sql</a></li>
<li><a href="#org78a1676">Global Schemas</a></li>
<li><a href="#org44dd87e">Local Schemas</a></li>
<li><a href="#orgdbc4f2f">Raft Nodes</a></li>
<li><a href="#orgebc5da4">Cluster nodes</a></li>
<li><a href="#orge148896">Containers</a></li>
</ul>
</li>
<li><a href="#org1f98b03">Network</a></li>
<li><a href="#orgf60ba93">Operations</a>
<ul>
<li><a href="#org825cfd6">Launch Container</a></li>
</ul>
</li>
<li><a href="#orgd0a5b21">Ansible</a>
<ul>
<li><a href="#orgc1ee722">Lxd connection</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-orga9e8f4c" class="outline-2">
<h2 id="orga9e8f4c">LXD Setup</h2>
<div class="outline-text-2" id="text-orga9e8f4c">
<p>
So easy to setup LXD!
</p>
</div>
<div id="outline-container-org86bdc9c" class="outline-3">
<h3 id="org86bdc9c">Deb or Snap</h3>
<div class="outline-text-3" id="text-org86bdc9c">
<p>
The existing lxd packages in ubuntu 16.04 are too old to use, which
need to be purged:
</p>
<div class="org-src-container">
<pre class="src src-sh">apt-get -qq purge lxd lxd-client
snap install lxd
</pre>
</div>

<p>
<code>lxd</code> is lxd daemon and <code>lxc</code> is the lxd client:
</p>
<div class="org-src-container">
<pre class="src src-sh">which lxd <span style="color: #73d216;">#</span><span style="color: #73d216;">=&gt;</span>
/snap/bin/lxd
which lxc <span style="color: #73d216;">#</span><span style="color: #73d216;">=&gt;</span>
/snap/bin/lxc
</pre>
</div>
</div>
</div>

<div id="outline-container-org4e171dc" class="outline-3">
<h3 id="org4e171dc">Init</h3>
<div class="outline-text-3" id="text-org4e171dc">
<p>
<code>lxd</code> provides a sub command <code>init</code> to init lxd:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxd init
</pre>
</div>

<p>
<code>lxd init</code> can configure <code>lxd</code> run in clustering mode or standalone
mode.
</p>
</div>
</div>
</div>

<div id="outline-container-orgb2025f0" class="outline-2">
<h2 id="orgb2025f0">Snap and Lxd</h2>
<div class="outline-text-2" id="text-orgb2025f0">
<p>
You can use <code>snap</code> to run <code>lxd</code>, or the opposite. Inside <code>lxd</code> you
can run <code>docker</code>.
</p>

<div class="org-src-container">
<pre class="src src-artist">+----------+       +-----------+       +------------+        +-----------+
|          |       |           |       |            |        |           |
|    vm    +------&gt;|    snap   +------&gt;|     lxd    +-------&gt;|   docker  |
|          |       |           |       |            |        |           |
+----------+       +-----------+       +------+-----+        +-----------+
                         ^                    |
                         |                    |
                         +--------------------+
</pre>
</div>
</div>

<div id="outline-container-orga8f5ead" class="outline-3">
<h3 id="orga8f5ead">Run lxd in Snap</h3>
<div class="outline-text-3" id="text-orga8f5ead">
<p>
By default ubuntu xenial with lxd and lxd client installed. You can
check this by running:
</p>

<div class="org-src-container">
<pre class="src src-sh">which lxd                       <span style="color: #73d216;"># </span><span style="color: #73d216;">=&gt; /usr/bin/lxd</span>
which lxc                       <span style="color: #73d216;"># </span><span style="color: #73d216;">=&gt; /usr/bin/lxc</span>
</pre>
</div>

<p>
The lxd in apt repo is very low. We need to switch to the lxd in
snap store:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #73d216;"># </span><span style="color: #73d216;">Uninstall existing lxd in ubuntu repo.</span>
apt-get purge -qq lxd lxd-client
<span style="color: #73d216;"># </span><span style="color: #73d216;">Install lxd in snap</span>
snap install lxd
<span style="color: #73d216;"># </span><span style="color: #73d216;">Check lxd and lxc</span>
which lxd                       <span style="color: #73d216;"># </span><span style="color: #73d216;">=&gt; /snap/bin/lxd</span>
lxd --version                   <span style="color: #73d216;"># </span><span style="color: #73d216;">=&gt; 3.3</span>
which lxc                       <span style="color: #73d216;"># </span><span style="color: #73d216;">=&gt; /snap/bin/lxc</span>
lxc --version                   <span style="color: #73d216;"># </span><span style="color: #73d216;">=&gt; 3.3</span>
<span style="color: #73d216;"># </span><span style="color: #73d216;">Init lxd</span>
lxd init
<span style="color: #73d216;"># </span><span style="color: #73d216;">Start lxd</span>
snap restart lxd
</pre>
</div>
</div>
</div>

<div id="outline-container-org7b763fc" class="outline-3">
<h3 id="org7b763fc">Launcn Lxd container</h3>
<div class="outline-text-3" id="text-org7b763fc">
<p>
Now launch a vm like <code>lxc</code> container:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #73d216;"># </span><span style="color: #73d216;">List images</span>
snap image list ubuntu:xenial
<span style="color: #73d216;"># </span><span style="color: #73d216;">Launch a container</span>
lxc launch ubuntu:xenial/amd64
<span style="color: #73d216;"># </span><span style="color: #73d216;">List containers</span>
lxc list
<span style="color: #73d216;"># </span><span style="color: #73d216;">exec bash in the container</span>
lxc exec steady-dingo bash
<span style="color: #73d216;"># </span><span style="color: #73d216;">Now you can do anything in the container</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd2d6fae" class="outline-3">
<h3 id="orgd2d6fae">Run snap inside Lxd Container</h3>
<div class="outline-text-3" id="text-orgd2d6fae">
<p>
Snap as a container, can run <code>lxd</code> and launch <code>lxd</code>
container. Inside the <code>lxc</code> container, you can run <code>snap</code>
container, say to install go snap:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxc exec steady-dingo bash
snap install go --classic
<span style="color: #e090d7;">echo</span> <span style="color: #e9b96e;">'export GOPATH=/usr/local'</span> &gt;&gt; ~/.bashrc
apt-get install build-essential
cat &gt; ~/.netrc &lt;&lt;EOF
<span style="color: #ffff00; font-weight: bold;">  your github toke  n</span>
<span style="color: #ffff00; font-weight: bold;">EOF</span>
go get github.ibm.com/nanjj/ncatd
ncatd --version                 <span style="color: #73d216;"># </span><span style="color: #73d216;">ncatd version 0.0.1</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeee63fa" class="outline-3">
<h3 id="orgeee63fa">Run Lxd inside Lxd Container</h3>
<div class="outline-text-3" id="text-orgeee63fa">
<p>
Run <code>lxd</code> inside lxd container nesting:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxc config set steady-dingo security.nesting true
lxc exec steady-dingo bash
apt-get purge -qq lxd lxd-client
snap install lxd
lxd init
lxc launch ubuntu:xenial/amd64
</pre>
</div>
</div>
</div>

<div id="outline-container-org8f0f001" class="outline-3">
<h3 id="org8f0f001">Run Docker inside Lxd Container</h3>
<div class="outline-text-3" id="text-org8f0f001">
<p>
With <code>security.nesting true</code>, run docker:
</p>

<div class="org-src-container">
<pre class="src src-sh">apt-get install docker.io
docker run hello-world
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf423aad" class="outline-3">
<h3 id="orgf423aad">Use Lxd Container as a Router</h3>
<div class="outline-text-3" id="text-orgf423aad">
<div class="org-src-container">
<pre class="src src-sh">lxc launch ubuntu:16.04 router <span style="color: #73d216;">#</span><span style="color: #73d216;">=&gt;</span>
lxc list <span style="color: #73d216;">#</span><span style="color: #73d216;">=&gt;</span>
+--------+---------+-----------------------+------+------------+-----------+
|  NAME  |  STATE  |         IPV4          | IPV6 |    TYPE    | SNAPSHOTS |
+--------+---------+-----------------------+------+------------+-----------+
| router | RUNNING |  10.149.11.203 (eth0) |      | PERSISTENT |           |
+--------+---------+-----------------------+------+------------+-----------+
lxc exec router -- bash -i
<span style="color: #73d216;"># </span><span style="color: #73d216;">configure vpn if needed</span>

<span style="color: #73d216;"># </span><span style="color: #73d216;">check ip forward setting</span>
sysctl net.ipv4.ip_forward <span style="color: #73d216;">#</span><span style="color: #73d216;">=&gt;</span>
net.ipv4.ip_forward = 1
<span style="color: #73d216;"># </span><span style="color: #73d216;">iptables</span>
iptables -t nat -A POSTROUTING -s 10.149.11.0/24 ! -d 10.0.2.0/24 -j MASQUERADE
apt-get update
apt-get install iptables-persistent
</pre>
</div>
<p>
Now you can use this as a router
</p>
</div>
</div>
</div>

<div id="outline-container-org88e8934" class="outline-2">
<h2 id="org88e8934">Clustering Mode</h2>
<div class="outline-text-2" id="text-org88e8934">
<p>
Lxd clustering mode makes lxd run in multiple nodes. Each node lxd
is running on is a cluster member. The whole set of the cluster
members is called a cluster.
</p>
</div>

<div id="outline-container-orgdd3ac39" class="outline-3">
<h3 id="orgdd3ac39">New Cluster</h3>
<div class="outline-text-3" id="text-orgdd3ac39">
<div class="org-src-container">
<pre class="src src-sh">lxd init
Would you like to use LXD clustering? (yes/no) [<span style="color: #fcaf3e;">default</span>=no]: yes
What name should be used to identify this node<span style="color: #b4fa70;"> in</span> the cluster? [<span style="color: #fcaf3e;">default</span>=hypercube01]:
What IP address or DNS name should be used to reach this node? [<span style="color: #fcaf3e;">default</span>=192.168.0.46]:
Are you joining an existing cluster? (yes/no) [<span style="color: #fcaf3e;">default</span>=no]:
Setup password authentication on the cluster? (yes/no) [<span style="color: #fcaf3e;">default</span>=yes]: yes
Trust password for new clients:
Again:
Do you want to configure a new local storage pool? (yes/no) [<span style="color: #fcaf3e;">default</span>=yes]:
Name of the storage backend to use (btrfs, dir, lvm, zfs) [<span style="color: #fcaf3e;">default</span>=zfs]:
Create a new ZFS pool? (yes/no) [<span style="color: #fcaf3e;">default</span>=yes]:
Would you like to use an existing block device? (yes/no) [<span style="color: #fcaf3e;">default</span>=no]:
Size<span style="color: #b4fa70;"> in</span> GB of the new loop device (1GB minimum) [<span style="color: #fcaf3e;">default</span>=31GB]: 128GB
Do you want to configure a new remote storage pool? (yes/no) [<span style="color: #fcaf3e;">default</span>=no]:
Would you like to connect to a MAAS server? (yes/no) [<span style="color: #fcaf3e;">default</span>=no]:
Would you like to configure LXD to use an existing bridge or host interface? (yes/no) [<span style="color: #fcaf3e;">default</span>=no]:
Would you like to create a new Fan overlay network? (yes/no) [<span style="color: #fcaf3e;">default</span>=yes]:
What subnet should be used as the Fan underlay? [<span style="color: #fcaf3e;">default</span>=auto]:
Would you like stale cached images to be updated automatically? (yes/no) [<span style="color: #fcaf3e;">default</span>=yes]
Would you like a YAML <span style="color: #e9b96e;">"lxd init"</span> preseed to be printed? (yes/no) [<span style="color: #fcaf3e;">default</span>=no]:
</pre>
</div>
</div>
</div>
<div id="outline-container-org1e4a9c7" class="outline-3">
<h3 id="org1e4a9c7">Join Cluster</h3>
<div class="outline-text-3" id="text-org1e4a9c7">
<div class="org-src-container">
<pre class="src src-sh">lxd init
Would you like to use LXD clustering? (yes/no) [<span style="color: #fcaf3e;">default</span>=no]: yes
What name should be used to identify this node<span style="color: #b4fa70;"> in</span> the cluster? [<span style="color: #fcaf3e;">default</span>=hypercube06]:
What IP address or DNS name should be used to reach this node? [<span style="color: #fcaf3e;">default</span>=192.168.0.21]:
Are you joining an existing cluster? (yes/no) [<span style="color: #fcaf3e;">default</span>=no]: yes
IP address or FQDN of an existing cluster node: 192.168.0.30
Cluster fingerprint: 6ab5b519ffbb309cb38b73657299dd9b0b8c6f2bd5b359974bf3bc77ce9c8977
You can validate this fingerprint by running <span style="color: #e9b96e;">"lxc info"</span> locally on an existing node.
Is this the correct fingerprint? (yes/no) [<span style="color: #fcaf3e;">default</span>=no]: yes
Cluster trust password:
All existing data is lost when joining a cluster, continue? (yes/no) [<span style="color: #fcaf3e;">default</span>=no] yes
Choose <span style="color: #e9b96e;">"size"</span> property for storage pool <span style="color: #e9b96e;">"local"</span>: 128GB
Choose <span style="color: #e9b96e;">"source"</span> property for storage pool <span style="color: #e9b96e;">"local"</span>:
Choose <span style="color: #e9b96e;">"zfs.pool_name"</span> property for storage pool <span style="color: #e9b96e;">"local"</span>:
Would you like a YAML <span style="color: #e9b96e;">"lxd init"</span> preseed to be printed? (yes/no) [<span style="color: #fcaf3e;">default</span>=no]:
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbe53a27" class="outline-3">
<h3 id="orgbe53a27">List Cluster</h3>
<div class="outline-text-3" id="text-orgbe53a27">
<div class="org-src-container">
<pre class="src src-sh">lxc cluster list

+-------------+---------------------------+----------+--------+-------------------+
|    NAME     |            URL            | DATABASE | STATE  |      MESSAGE      |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube01 | https://192.168.0.46:8443 | YES      | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube02 | https://192.168.0.47:8443 | YES      | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube03 | https://192.168.0.48:8443 | YES      | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube04 | https://192.168.0.51:8443 | NO       | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube05 | https://192.168.0.30:8443 | NO       | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube06 | https://192.168.0.21:8443 | NO       | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube07 | https://192.168.0.26:8443 | NO       | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
</pre>
</div>
<p>
It's a 7 nodes lxd cluster with 3 database nodes and 7 service
nodes.
</p>
</div>
</div>
</div>
<div id="outline-container-orgba57208" class="outline-2">
<h2 id="orgba57208">Database</h2>
<div class="outline-text-2" id="text-orgba57208">
<p>
<a href="https://github.com/lxc/lxd/blob/master/doc/database.md">Lxd database</a> is based on <a href="https://github.com/CanonicalLtd/dqlite">distributed sqlite</a>, which removed lxd's
dependency on traditional database like postgres or mysql. <a href="https://wiki.ubuntu.com/FanNetworking">Fan
network</a> introduced lxd a simple and fast container network.
</p>
</div>
<div id="outline-container-org410e40c" class="outline-3">
<h3 id="org410e40c">Global and Local</h3>
<div class="outline-text-3" id="text-org410e40c">
<p>
For each lxd node, there are two type databases: global and
local. Data in global database is shared by each lxd cluster
members, while data in local database can only be accessed in
local node, does not impact others.
</p>
</div>
</div>
<div id="outline-container-orgfe40e8d" class="outline-3">
<h3 id="orgfe40e8d">Lxd sql</h3>
<div class="outline-text-3" id="text-orgfe40e8d">
<div class="org-src-container">
<pre class="src src-sh">lxd sql &lt;local|global&gt; &lt;query&gt;  [flags]
</pre>
</div>
</div>
</div>
<div id="outline-container-org78a1676" class="outline-3">
<h3 id="org78a1676">Global Schemas</h3>
<div class="outline-text-3" id="text-org78a1676">
<p>
For example, to list global schemas:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxd sql global .schema <span style="color: #73d216;">#</span><span style="color: #73d216;">=&gt;</span>
PRAGMA <span style="color: #fcaf3e;">foreign_keys</span>=OFF;
BEGIN TRANSACTION;
CREATE TABLE schema (
    id         INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    version    INTEGER NOT NULL,
    updated_at DATETIME NOT NULL,
    UNIQUE (version)
);
INSERT INTO schema VALUES(1,13,1546788241);
CREATE TABLE <span style="color: #e9b96e;">"containers"</span> (
    id INTEGER primary key AUTOINCREMENT NOT NULL,
    node_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    architecture INTEGER NOT NULL,
    <span style="color: #e090d7;">type</span> INTEGER NOT NULL,
    ephemeral INTEGER NOT NULL DEFAULT 0,
    creation_date DATETIME NOT NULL DEFAULT 0,
    stateful INTEGER NOT NULL DEFAULT 0,
    last_use_date DATETIME,
    description TEXT,
    project_id INTEGER NOT NULL,
    UNIQUE (project_id, name),
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE <span style="color: #e9b96e;">"images"</span> (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    fingerprint TEXT NOT NULL,
    filename TEXT NOT NULL,
    size INTEGER NOT NULL,
    public INTEGER NOT NULL DEFAULT 0,
    architecture INTEGER NOT NULL,
    creation_date DATETIME,
    expiry_date DATETIME,
    upload_date DATETIME NOT NULL,
    cached INTEGER NOT NULL DEFAULT 0,
    last_use_date DATETIME,
    auto_update INTEGER NOT NULL DEFAULT 0,
    project_id INTEGER NOT NULL,
    UNIQUE (project_id, fingerprint),
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE <span style="color: #e9b96e;">"images_aliases"</span> (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    image_id INTEGER NOT NULL,
    description TEXT,
    project_id INTEGER NOT NULL,
    UNIQUE (project_id, name),
    FOREIGN KEY (image_id) REFERENCES images (id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE <span style="color: #e9b96e;">"operations"</span> (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    uuid TEXT NOT NULL,
    node_id TEXT NOT NULL,
    <span style="color: #e090d7;">type</span> INTEGER NOT NULL DEFAULT 0,
    project_id INTEGER,
    UNIQUE (uuid),
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE <span style="color: #e9b96e;">"profiles"</span> (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    project_id INTEGER NOT NULL,
    UNIQUE (project_id, name),
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE <span style="color: #e9b96e;">"storage_volumes"</span> (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    storage_pool_id INTEGER NOT NULL,
    node_id INTEGER NOT NULL,
    <span style="color: #e090d7;">type</span> INTEGER NOT NULL,
    description TEXT,
    snapshot INTEGER NOT NULL DEFAULT 0,
    project_id INTEGER NOT NULL,
    UNIQUE (storage_pool_id, node_id, project_id, name, type),
    FOREIGN KEY (storage_pool_id) REFERENCES storage_pools (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE certificates (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    fingerprint TEXT NOT NULL,
    <span style="color: #e090d7;">type</span> INTEGER NOT NULL,
    name TEXT NOT NULL,
    certificate TEXT NOT NULL,
    UNIQUE (fingerprint)
);
CREATE TABLE config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (key)
);
CREATE TABLE containers_backups (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    container_id INTEGER NOT NULL,
    name VARCHAR(255) NOT NULL,
    creation_date DATETIME,
    expiry_date DATETIME,
    container_only INTEGER NOT NULL default 0,
    optimized_storage INTEGER NOT NULL default 0,
    FOREIGN KEY (container_id) REFERENCES containers (id) ON DELETE CASCADE,
    UNIQUE (container_id, name)
);
CREATE TABLE containers_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    container_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    FOREIGN KEY (container_id) REFERENCES containers (id) ON DELETE CASCADE,
    UNIQUE (container_id, key)
);
CREATE TABLE containers_devices (
    id INTEGER primary key AUTOINCREMENT NOT NULL,
    container_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    <span style="color: #e090d7;">type</span> INTEGER NOT NULL default 0,
    FOREIGN KEY (container_id) REFERENCES containers (id) ON DELETE CASCADE,
    UNIQUE (container_id, name)
);
CREATE TABLE containers_devices_config (
    id INTEGER primary key AUTOINCREMENT NOT NULL,
    container_device_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    FOREIGN KEY (container_device_id) REFERENCES containers_devices (id) ON DELETE CASCADE,
    UNIQUE (container_device_id, key)
);
CREATE TABLE containers_profiles (
    id INTEGER primary key AUTOINCREMENT NOT NULL,
    container_id INTEGER NOT NULL,
    profile_id INTEGER NOT NULL,
    apply_order INTEGER NOT NULL default 0,
    UNIQUE (container_id, profile_id),
    FOREIGN KEY (container_id) REFERENCES containers(id) ON DELETE CASCADE,
    FOREIGN KEY (profile_id) REFERENCES profiles(id) ON DELETE CASCADE
);
CREATE TABLE images_nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    image_id INTEGER NOT NULL,
    node_id INTEGER NOT NULL,
    UNIQUE (image_id, node_id),
    FOREIGN KEY (image_id) REFERENCES images (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE
);
CREATE TABLE images_properties (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    image_id INTEGER NOT NULL,
    <span style="color: #e090d7;">type</span> INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    FOREIGN KEY (image_id) REFERENCES images (id) ON DELETE CASCADE
);
CREATE TABLE images_source (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    image_id INTEGER NOT NULL,
    server TEXT NOT NULL,
    protocol INTEGER NOT NULL,
    certificate TEXT NOT NULL,
    <span style="color: #e090d7;">alias</span> TEXT NOT NULL,
    FOREIGN KEY (image_id) REFERENCES images (id) ON DELETE CASCADE
);
CREATE TABLE networks (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    state INTEGER NOT NULL DEFAULT 0,
    UNIQUE (name)
);
CREATE TABLE networks_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    network_id INTEGER NOT NULL,
    node_id INTEGER,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (network_id, node_id, key),
    FOREIGN KEY (network_id) REFERENCES networks (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE
);
CREATE TABLE networks_nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    network_id INTEGER NOT NULL,
    node_id INTEGER NOT NULL,
    UNIQUE (network_id, node_id),
    FOREIGN KEY (network_id) REFERENCES networks (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE
);
CREATE TABLE nodes (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT DEFAULT <span style="color: #e9b96e;">''</span>,
    address TEXT NOT NULL,
    schema INTEGER NOT NULL,
    api_extensions INTEGER NOT NULL,
    heartbeat DATETIME DEFAULT CURRENT_TIMESTAMP,
    pending INTEGER NOT NULL DEFAULT 0,
    UNIQUE (name),
    UNIQUE (address)
);
CREATE TABLE profiles_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    profile_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (profile_id, key),
    FOREIGN KEY (profile_id) REFERENCES profiles(id) ON DELETE CASCADE
);
CREATE TABLE profiles_devices (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    profile_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    <span style="color: #e090d7;">type</span> INTEGER NOT NULL default 0,
    UNIQUE (profile_id, name),
    FOREIGN KEY (profile_id) REFERENCES profiles (id) ON DELETE CASCADE
);
CREATE TABLE profiles_devices_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    profile_device_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (profile_device_id, key),
    FOREIGN KEY (profile_device_id) REFERENCES profiles_devices (id) ON DELETE CASCADE
);
CREATE TABLE projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    UNIQUE (name)
);
CREATE TABLE projects_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    project_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE,
    UNIQUE (project_id, key)
);
CREATE TABLE storage_pools (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    driver TEXT NOT NULL,
    description TEXT,
    state INTEGER NOT NULL DEFAULT 0,
    UNIQUE (name)
);
CREATE TABLE storage_pools_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    storage_pool_id INTEGER NOT NULL,
    node_id INTEGER,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (storage_pool_id, node_id, key),
    FOREIGN KEY (storage_pool_id) REFERENCES storage_pools (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE
);
CREATE TABLE storage_pools_nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    storage_pool_id INTEGER NOT NULL,
    node_id INTEGER NOT NULL,
    UNIQUE (storage_pool_id, node_id),
    FOREIGN KEY (storage_pool_id) REFERENCES storage_pools (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE
);
CREATE TABLE storage_volumes_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    storage_volume_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (storage_volume_id, key),
    FOREIGN KEY (storage_volume_id) REFERENCES storage_volumes (id) ON DELETE CASCADE
);
COMMIT;
</pre>
</div>
</div>
</div>
<div id="outline-container-org44dd87e" class="outline-3">
<h3 id="org44dd87e">Local Schemas</h3>
<div class="outline-text-3" id="text-org44dd87e">
<p>
To list local database schemas:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxd sql local .schema <span style="color: #73d216;">#</span><span style="color: #73d216;">=&gt;</span>
PRAGMA <span style="color: #fcaf3e;">foreign_keys</span>=OFF;
BEGIN TRANSACTION;
CREATE TABLE schema (
    id         INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    version    INTEGER NOT NULL,
    updated_at DATETIME NOT NULL,
    UNIQUE (version)
);
INSERT INTO schema VALUES(1,38,1546788240);
CREATE TABLE config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    key VARCHAR(255) NOT NULL,
    value TEXT,
    UNIQUE (key)
);
CREATE TABLE patches (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name VARCHAR(255) NOT NULL,
    applied_at DATETIME NOT NULL,
    UNIQUE (name)
);
CREATE TABLE raft_nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    address TEXT NOT NULL,
    UNIQUE (address)
);
COMMIT;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdbc4f2f" class="outline-3">
<h3 id="orgdbc4f2f">Raft Nodes</h3>
<div class="outline-text-3" id="text-orgdbc4f2f">
<div class="org-src-container">
<pre class="src src-sh">lxd sql local <span style="color: #e9b96e;">'select * from raft_nodes'</span> <span style="color: #73d216;">#</span><span style="color: #73d216;">=&gt;</span>
+----+-------------------+
| id |      address      |
+----+-------------------+
| 1  | 192.168.0.46:8443 |
| 2  | 192.168.0.47:8443 |
| 3  | 192.168.0.48:8443 |
+----+-------------------+
</pre>
</div>
<p>
<a href="https://github.com/CanonicalLtd/dqlite">Distributed Sqlite</a> is using raft to sync sqlite db logs.
</p>
</div>
</div>
<div id="outline-container-orgebc5da4" class="outline-3">
<h3 id="orgebc5da4">Cluster nodes</h3>
<div class="outline-text-3" id="text-orgebc5da4">
<div class="org-src-container">
<pre class="src src-sh">lxd sql global <span style="color: #e9b96e;">'select * from nodes'</span>
+----+-------------+-------------------+--------+----------------+--------------------------------+---------+
| id |    name     |      address      | schema | api_extensions |           heartbeat            | pending |
+----+-------------+-------------------+--------+----------------+--------------------------------+---------+
| 1  | hypercube01 | 192.168.0.46:8443 | 13     | 115            | 2019-01-29T12:09:42.37271017Z  | 0       |
| 2  | hypercube02 | 192.168.0.47:8443 | 13     | 115            | 2019-01-29T12:09:42.45776374Z  | 0       |
| 3  | hypercube03 | 192.168.0.48:8443 | 13     | 115            | 2019-01-29T12:09:42.521913386Z | 0       |
| 4  | hypercube04 | 192.168.0.51:8443 | 13     | 115            | 2019-01-29T12:09:42.599993638Z | 0       |
| 5  | hypercube05 | 192.168.0.30:8443 | 13     | 115            | 2019-01-29T12:09:42.661997234Z | 0       |
| 6  | hypercube06 | 192.168.0.21:8443 | 13     | 115            | 2019-01-29T12:09:42.733539797Z | 0       |
| 7  | hypercube07 | 192.168.0.26:8443 | 13     | 115            | 2019-01-29T12:09:42.796405819Z | 0       |
+----+-------------+-------------------+--------+----------------+--------------------------------+---------+
</pre>
</div>
</div>
</div>
<div id="outline-container-orge148896" class="outline-3">
<h3 id="orge148896">Containers</h3>
<div class="outline-text-3" id="text-orge148896">
<div class="org-src-container">
<pre class="src src-sh">lxd sql global <span style="color: #e9b96e;">'select * from containers'</span> <span style="color: #73d216;">#</span><span style="color: #73d216;">=&gt;</span>
+----+---------+----------------+------------+
| id | node_id |      name      | project_id |
+----+---------+----------------+------------+
| 20 | 2       | grafana        | 1          |
| 30 | 3       | go             | 1          |
| 32 | 1       | guyujie        | 1          |
| 33 | 4       | nginx          | 1          |
| 36 | 1       | lxdui01        | 1          |
| 38 | 1       | crack-mako     | 1          |
| 39 | 5       | lxdui02        | 1          |
| 42 | 6       | fluent-hamster | 1          |
| 43 | 1       | b2             | 1          |
| 44 | 2       | b3             | 1          |
+----+---------+----------------+------------+
</pre>
</div>
<p>
To select the node with least containers:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxd sql global <span style="color: #e9b96e;">\</span>
    <span style="color: #e9b96e;">'select node_id, count(node_id) as node_count from containers</span>
<span style="color: #e9b96e;">     group by node_id order by node_count'</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1f98b03" class="outline-2">
<h2 id="org1f98b03">Network</h2>
<div class="outline-text-2" id="text-org1f98b03">
<p>
Lxd can be configured to use <a href="https://wiki.ubuntu.com/FanNetworking">Ubuntu Fan Network</a>.
</p>

<p>
Say 2 containers A and B:
</p>
<table>


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Container</th>
<th scope="col" class="org-left">IP</th>
<th scope="col" class="org-left">Hyper</th>
<th scope="col" class="org-left">Hyper IP</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">A</td>
<td class="org-left">240.0.46.14/8</td>
<td class="org-left">hypercube01</td>
<td class="org-left">192.168.0.46/16</td>
</tr>

<tr>
<td class="org-left">B</td>
<td class="org-left">240.0.47.99/8</td>
<td class="org-left">hypercube02</td>
<td class="org-left">192.168.0.47/16</td>
</tr>
</tbody>
</table>

<p>
Now ping B on A:
</p>
<div class="org-src-container">
<pre class="src src-sh">ping 240.0.47.99 <span style="color: #73d216;">#</span><span style="color: #73d216;">=&gt;</span>
ARP, Request who-has 240.0.47.99 tell 240.0.46.14, length 28
</pre>
</div>
<p>
On hypercube01 the arp request being forwarded to hypercube02:
</p>
<div class="org-src-container">
<pre class="src src-sh">17:07:29.650323 IP 192.168.0.46.53730 &gt; 192.168.0.47.8472
ARP, Request who-has 240.0.47.99 tell 240.0.46.14, length 28
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf60ba93" class="outline-2">
<h2 id="orgf60ba93">Operations</h2>
<div class="outline-text-2" id="text-orgf60ba93">
</div>
<div id="outline-container-org825cfd6" class="outline-3">
<h3 id="org825cfd6">Launch Container</h3>
<div class="outline-text-3" id="text-org825cfd6">
<p>
<code>lxc launch b --debug</code> will do:
</p>
<ol class="org-ol">
<li><p>
Get version
</p>
<div class="org-src-container">
<pre class="src src-sh">DBUG[01-22|14:13:15] Connecting to a remote LXD over HTTPs
DBUG[01-22|14:13:15] Sending request to LXD                   <span style="color: #fcaf3e;">method</span>=GET <span style="color: #fcaf3e;">url</span>=https://192.168.0.48:8443/1.0 <span style="color: #fcaf3e;">etag</span>=
DBUG[01-22|14:13:17] Got response struct from LXD
DBUG[01-22|14:13:17]
        {
                <span style="color: #e9b96e;">"config"</span>: {
                        <span style="color: #e9b96e;">"cluster.https_address"</span>: <span style="color: #e9b96e;">"192.168.0.48:8443"</span>,
                        <span style="color: #e9b96e;">"core.https_address"</span>: <span style="color: #e9b96e;">"192.168.0.48:8443"</span>,
                        <span style="color: #e9b96e;">"core.trust_password"</span>: true
                },
                <span style="color: #e9b96e;">"api_extensions"</span>: [...],
                <span style="color: #e9b96e;">"api_status"</span>: <span style="color: #e9b96e;">"stable"</span>,
                <span style="color: #e9b96e;">"api_version"</span>: <span style="color: #e9b96e;">"1.0"</span>,
                <span style="color: #e9b96e;">"auth"</span>: <span style="color: #e9b96e;">"trusted"</span>,
                <span style="color: #e9b96e;">"public"</span>: false,
                <span style="color: #e9b96e;">"auth_methods"</span>: [
                        <span style="color: #e9b96e;">"tls"</span>
                ],
                <span style="color: #e9b96e;">"environment"</span>: {
                        <span style="color: #e9b96e;">"addresses"</span>: [
                                <span style="color: #e9b96e;">"192.168.0.48:8443"</span>
                        ],
                        <span style="color: #e9b96e;">"architectures"</span>: [
                                <span style="color: #e9b96e;">"x86_64"</span>,
                                <span style="color: #e9b96e;">"i686"</span>
                        ],
                        <span style="color: #e9b96e;">"certificate"</span>: <span style="color: #e9b96e;">"..."</span>,
                        <span style="color: #e9b96e;">"certificate_fingerprint"</span>: <span style="color: #e9b96e;">"..."</span>,
                        <span style="color: #e9b96e;">"driver"</span>: <span style="color: #e9b96e;">"lxc"</span>,
                        <span style="color: #e9b96e;">"driver_version"</span>: <span style="color: #e9b96e;">"3.1.0"</span>,
                        <span style="color: #e9b96e;">"kernel"</span>: <span style="color: #e9b96e;">"Linux"</span>,
                        <span style="color: #e9b96e;">"kernel_architecture"</span>: <span style="color: #e9b96e;">"x86_64"</span>,
                        <span style="color: #e9b96e;">"kernel_version"</span>: <span style="color: #e9b96e;">"4.15.0-43-generic"</span>,
                        <span style="color: #e9b96e;">"server"</span>: <span style="color: #e9b96e;">"lxd"</span>,
                        <span style="color: #e9b96e;">"server_pid"</span>: 32645,
                        <span style="color: #e9b96e;">"server_version"</span>: <span style="color: #e9b96e;">"3.9"</span>,
                        <span style="color: #e9b96e;">"storage"</span>: <span style="color: #e9b96e;">"zfs"</span>,
                        <span style="color: #e9b96e;">"storage_version"</span>: <span style="color: #e9b96e;">"0.7.5-1ubuntu16.4"</span>,
                        <span style="color: #e9b96e;">"server_clustered"</span>: true,
                        <span style="color: #e9b96e;">"server_name"</span>: <span style="color: #e9b96e;">"hypercube03"</span>,
                        <span style="color: #e9b96e;">"project"</span>: <span style="color: #e9b96e;">"default"</span>
                }
        }
</pre>
</div></li>
<li><p>
Get image
</p>
<div class="org-src-container">
<pre class="src src-sh">Creating the container
DBUG[01-22|14:13:17] Sending request to LXD                   <span style="color: #fcaf3e;">method</span>=GET <span style="color: #fcaf3e;">url</span>=https://192.168.0.48:8443/1.0/images/aliases/b <span style="color: #fcaf3e;">etag</span>=
DBUG[01-22|14:13:19] Got response struct from LXD
DBUG[01-22|14:13:19]
        {
                <span style="color: #e9b96e;">"description"</span>: <span style="color: #e9b96e;">""</span>,
                <span style="color: #e9b96e;">"target"</span>: <span style="color: #e9b96e;">"dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700"</span>,
                <span style="color: #e9b96e;">"name"</span>: <span style="color: #e9b96e;">"b"</span>
        }
DBUG[01-22|14:13:19] Sending request to LXD                   <span style="color: #fcaf3e;">method</span>=GET <span style="color: #fcaf3e;">url</span>=https://192.168.0.48:8443/1.0/images/dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700 <span style="color: #fcaf3e;">etag</span>=
DBUG[01-22|14:13:20] Got response struct from LXD
DBUG[01-22|14:13:20]
        {
                <span style="color: #e9b96e;">"auto_update"</span>: true,
                <span style="color: #e9b96e;">"properties"</span>: {
                        <span style="color: #e9b96e;">"architecture"</span>: <span style="color: #e9b96e;">"amd64"</span>,
                        <span style="color: #e9b96e;">"description"</span>: <span style="color: #e9b96e;">"ubuntu 18.04 LTS amd64 (release) (20190114)"</span>,
                        <span style="color: #e9b96e;">"label"</span>: <span style="color: #e9b96e;">"release"</span>,
                        <span style="color: #e9b96e;">"os"</span>: <span style="color: #e9b96e;">"ubuntu"</span>,
                        <span style="color: #e9b96e;">"release"</span>: <span style="color: #e9b96e;">"bionic"</span>,
                        <span style="color: #e9b96e;">"serial"</span>: <span style="color: #e9b96e;">"20190114"</span>,
                        <span style="color: #e9b96e;">"version"</span>: <span style="color: #e9b96e;">"18.04"</span>
                },
                <span style="color: #e9b96e;">"public"</span>: false,
                <span style="color: #e9b96e;">"aliases"</span>: [
                        {
                                <span style="color: #e9b96e;">"name"</span>: <span style="color: #e9b96e;">"b"</span>,
                                <span style="color: #e9b96e;">"description"</span>: <span style="color: #e9b96e;">""</span>
                        }
                ],
                <span style="color: #e9b96e;">"architecture"</span>: <span style="color: #e9b96e;">"x86_64"</span>,
                <span style="color: #e9b96e;">"cached"</span>: true,
                <span style="color: #e9b96e;">"filename"</span>: <span style="color: #e9b96e;">"ubuntu-18.04-server-cloudimg-amd64-lxd.tar.xz"</span>,
                <span style="color: #e9b96e;">"fingerprint"</span>: <span style="color: #e9b96e;">"dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700"</span>,
                <span style="color: #e9b96e;">"size"</span>: 183468820,
                <span style="color: #e9b96e;">"update_source"</span>: {
                        <span style="color: #e9b96e;">"alias"</span>: <span style="color: #e9b96e;">"b"</span>,
                        <span style="color: #e9b96e;">"certificate"</span>: <span style="color: #e9b96e;">""</span>,
                        <span style="color: #e9b96e;">"protocol"</span>: <span style="color: #e9b96e;">"simplestreams"</span>,
                        <span style="color: #e9b96e;">"server"</span>: <span style="color: #e9b96e;">"https://cloud-images.ubuntu.com/releases"</span>
                },
                <span style="color: #e9b96e;">"created_at"</span>: <span style="color: #e9b96e;">"2019-01-14T00:00:00Z"</span>,
                <span style="color: #e9b96e;">"expires_at"</span>: <span style="color: #e9b96e;">"2023-04-26T00:00:00Z"</span>,
                <span style="color: #e9b96e;">"last_used_at"</span>: <span style="color: #e9b96e;">"2019-01-18T08:22:28.5476208Z"</span>,
                <span style="color: #e9b96e;">"uploaded_at"</span>: <span style="color: #e9b96e;">"2019-01-15T00:36:47.651093161Z"</span>
        }
</pre>
</div></li>
<li><p>
Create Container Operation
</p>
<div class="org-src-container">
<pre class="src src-sh">DBUG[01-22|14:13:22] Connected to the websocket
DBUG[01-22|14:13:22] Sending request to LXD                   <span style="color: #fcaf3e;">method</span>=POST <span style="color: #fcaf3e;">url</span>=https://192.168.0.48:8443/1.0/containers <span style="color: #fcaf3e;">etag</span>=
DBUG[01-22|14:13:22]
        {
                <span style="color: #e9b96e;">"architecture"</span>: <span style="color: #e9b96e;">""</span>,
                <span style="color: #e9b96e;">"config"</span>: {},
                <span style="color: #e9b96e;">"devices"</span>: {},
                <span style="color: #e9b96e;">"ephemeral"</span>: false,
                <span style="color: #e9b96e;">"profiles"</span>: null,
                <span style="color: #e9b96e;">"stateful"</span>: false,
                <span style="color: #e9b96e;">"description"</span>: <span style="color: #e9b96e;">""</span>,
                <span style="color: #e9b96e;">"name"</span>: <span style="color: #e9b96e;">""</span>,
                <span style="color: #e9b96e;">"source"</span>: {
                        <span style="color: #e9b96e;">"type"</span>: <span style="color: #e9b96e;">"image"</span>,
                        <span style="color: #e9b96e;">"certificate"</span>: <span style="color: #e9b96e;">""</span>,
                        <span style="color: #e9b96e;">"fingerprint"</span>: <span style="color: #e9b96e;">"dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700"</span>
                },
                <span style="color: #e9b96e;">"instance_type"</span>: <span style="color: #e9b96e;">""</span>
        }
DBUG[01-22|14:13:24] Got operation from LXD
DBUG[01-22|14:13:24]
        {
                <span style="color: #e9b96e;">"id"</span>: <span style="color: #e9b96e;">"1de45646-d209-413f-827a-ef7921c3c7f8"</span>,
                <span style="color: #e9b96e;">"class"</span>: <span style="color: #e9b96e;">"task"</span>,
                <span style="color: #e9b96e;">"description"</span>: <span style="color: #e9b96e;">"Creating container"</span>,
                <span style="color: #e9b96e;">"created_at"</span>: <span style="color: #e9b96e;">"2019-01-22T06:13:23.360302136Z"</span>,
                <span style="color: #e9b96e;">"updated_at"</span>: <span style="color: #e9b96e;">"2019-01-22T06:13:23.360302136Z"</span>,
                <span style="color: #e9b96e;">"status"</span>: <span style="color: #e9b96e;">"Running"</span>,
                <span style="color: #e9b96e;">"status_code"</span>: 103,
                <span style="color: #e9b96e;">"resources"</span>: {
                        <span style="color: #e9b96e;">"containers"</span>: [
                                <span style="color: #e9b96e;">"/1.0/containers/fluent-hamster"</span>
                        ]
                },
                <span style="color: #e9b96e;">"metadata"</span>: null,
                <span style="color: #e9b96e;">"may_cancel"</span>: false,
                <span style="color: #e9b96e;">"err"</span>: <span style="color: #e9b96e;">""</span>
        }
</pre>
</div></li>
<li><p>
Wait Create Operation Done
</p>
<div class="org-src-container">
<pre class="src src-sh">DBUG[01-22|14:13:24] Sending request to LXD                   <span style="color: #fcaf3e;">method</span>=GET <span style="color: #fcaf3e;">url</span>=https://192.168.0.48:8443/1.0/operations/1de45646-d209-413f-827a-ef7921c3c7f8 <span style="color: #fcaf3e;">etag</span>=
DBUG[01-22|14:13:25] Got response struct from LXD
DBUG[01-22|14:13:25]
        {
                <span style="color: #e9b96e;">"id"</span>: <span style="color: #e9b96e;">"1de45646-d209-413f-827a-ef7921c3c7f8"</span>,
                <span style="color: #e9b96e;">"class"</span>: <span style="color: #e9b96e;">"task"</span>,
                <span style="color: #e9b96e;">"description"</span>: <span style="color: #e9b96e;">"Creating container"</span>,
                <span style="color: #e9b96e;">"created_at"</span>: <span style="color: #e9b96e;">"2019-01-22T06:13:23.360302136Z"</span>,
                <span style="color: #e9b96e;">"updated_at"</span>: <span style="color: #e9b96e;">"2019-01-22T06:13:23.360302136Z"</span>,
                <span style="color: #e9b96e;">"status"</span>: <span style="color: #e9b96e;">"Running"</span>,
                <span style="color: #e9b96e;">"status_code"</span>: 103,
                <span style="color: #e9b96e;">"resources"</span>: {
                        <span style="color: #e9b96e;">"containers"</span>: [
                                <span style="color: #e9b96e;">"/1.0/containers/fluent-hamster"</span>
                        ]
                },
                <span style="color: #e9b96e;">"metadata"</span>: null,
                <span style="color: #e9b96e;">"may_cancel"</span>: false,
                <span style="color: #e9b96e;">"err"</span>: <span style="color: #e9b96e;">""</span>
        }
Container name is: fluent-hamster
</pre>
</div></li>
<li><p>
Get container
</p>
<div class="org-src-container">
<pre class="src src-sh">DBUG[01-22|14:13:37] Sending request to LXD                   <span style="color: #fcaf3e;">method</span>=GET <span style="color: #fcaf3e;">url</span>=https://192.168.0.48:8443/1.0/containers/fluent-hamster <span style="color: #fcaf3e;">etag</span>=
DBUG[01-22|14:13:39] Got response struct from LXD
DBUG[01-22|14:13:39]
        {
                <span style="color: #e9b96e;">"architecture"</span>: <span style="color: #e9b96e;">"x86_64"</span>,
                <span style="color: #e9b96e;">"config"</span>: {
                        <span style="color: #e9b96e;">"image.architecture"</span>: <span style="color: #e9b96e;">"amd64"</span>,
                        <span style="color: #e9b96e;">"image.description"</span>: <span style="color: #e9b96e;">"ubuntu 18.04 LTS amd64 (release) (20190114)"</span>,
                        <span style="color: #e9b96e;">"image.label"</span>: <span style="color: #e9b96e;">"release"</span>,
                        <span style="color: #e9b96e;">"image.os"</span>: <span style="color: #e9b96e;">"ubuntu"</span>,
                        <span style="color: #e9b96e;">"image.release"</span>: <span style="color: #e9b96e;">"bionic"</span>,
                        <span style="color: #e9b96e;">"image.serial"</span>: <span style="color: #e9b96e;">"20190114"</span>,
                        <span style="color: #e9b96e;">"image.version"</span>: <span style="color: #e9b96e;">"18.04"</span>,
                        <span style="color: #e9b96e;">"volatile.apply_template"</span>: <span style="color: #e9b96e;">"create"</span>,
                        <span style="color: #e9b96e;">"volatile.base_image"</span>: <span style="color: #e9b96e;">"dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700"</span>,
                        <span style="color: #e9b96e;">"volatile.eth0.hwaddr"</span>: <span style="color: #e9b96e;">"00:16:3e:e3:bf:17"</span>,
                        <span style="color: #e9b96e;">"volatile.idmap.base"</span>: <span style="color: #e9b96e;">"0"</span>,
                        <span style="color: #e9b96e;">"volatile.idmap.next"</span>: <span style="color: #e9b96e;">"[{\"Isuid\":true,\"Isgid\":true,\"Hostid\":1000000,\"Nsid\":0,\"Maprange\":1000000000}]"</span>,
                        <span style="color: #e9b96e;">"volatile.last_state.idmap"</span>: <span style="color: #e9b96e;">"[{\"Isuid\":true,\"Isgid\":true,\"Hostid\":1000000,\"Nsid\":0,\"Maprange\":1000000000}]"</span>
                },
                <span style="color: #e9b96e;">"devices"</span>: {},
                <span style="color: #e9b96e;">"ephemeral"</span>: false,
                <span style="color: #e9b96e;">"profiles"</span>: [
                        <span style="color: #e9b96e;">"default"</span>
                ],
                <span style="color: #e9b96e;">"stateful"</span>: false,
                <span style="color: #e9b96e;">"description"</span>: <span style="color: #e9b96e;">""</span>,
                <span style="color: #e9b96e;">"created_at"</span>: <span style="color: #e9b96e;">"2019-01-22T06:13:29.053538619Z"</span>,
                <span style="color: #e9b96e;">"expanded_config"</span>: {
                        <span style="color: #e9b96e;">"image.architecture"</span>: <span style="color: #e9b96e;">"amd64"</span>,
                        <span style="color: #e9b96e;">"image.description"</span>: <span style="color: #e9b96e;">"ubuntu 18.04 LTS amd64 (release) (20190114)"</span>,
                        <span style="color: #e9b96e;">"image.label"</span>: <span style="color: #e9b96e;">"release"</span>,
                        <span style="color: #e9b96e;">"image.os"</span>: <span style="color: #e9b96e;">"ubuntu"</span>,
                        <span style="color: #e9b96e;">"image.release"</span>: <span style="color: #e9b96e;">"bionic"</span>,
                        <span style="color: #e9b96e;">"image.serial"</span>: <span style="color: #e9b96e;">"20190114"</span>,
                        <span style="color: #e9b96e;">"image.version"</span>: <span style="color: #e9b96e;">"18.04"</span>,
                        <span style="color: #e9b96e;">"volatile.apply_template"</span>: <span style="color: #e9b96e;">"create"</span>,
                        <span style="color: #e9b96e;">"volatile.base_image"</span>: <span style="color: #e9b96e;">"dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700"</span>,
                        <span style="color: #e9b96e;">"volatile.eth0.hwaddr"</span>: <span style="color: #e9b96e;">"00:16:3e:e3:bf:17"</span>,
                        <span style="color: #e9b96e;">"volatile.idmap.base"</span>: <span style="color: #e9b96e;">"0"</span>,
                        <span style="color: #e9b96e;">"volatile.idmap.next"</span>: <span style="color: #e9b96e;">"[{\"Isuid\":true,\"Isgid\":true,\"Hostid\":1000000,\"Nsid\":0,\"Maprange\":1000000000}]"</span>,
                        <span style="color: #e9b96e;">"volatile.last_state.idmap"</span>: <span style="color: #e9b96e;">"[{\"Isuid\":true,\"Isgid\":true,\"Hostid\":1000000,\"Nsid\":0,\"Maprange\":1000000000}]"</span>
                },
                <span style="color: #e9b96e;">"expanded_devices"</span>: {
                        <span style="color: #e9b96e;">"eth0"</span>: {
                                <span style="color: #e9b96e;">"name"</span>: <span style="color: #e9b96e;">"eth0"</span>,
                                <span style="color: #e9b96e;">"nictype"</span>: <span style="color: #e9b96e;">"bridged"</span>,
                                <span style="color: #e9b96e;">"parent"</span>: <span style="color: #e9b96e;">"lxdfan0"</span>,
                                <span style="color: #e9b96e;">"type"</span>: <span style="color: #e9b96e;">"nic"</span>
                        },
                        <span style="color: #e9b96e;">"root"</span>: {
                                <span style="color: #e9b96e;">"path"</span>: <span style="color: #e9b96e;">"/"</span>,
                                <span style="color: #e9b96e;">"pool"</span>: <span style="color: #e9b96e;">"local"</span>,
                                <span style="color: #e9b96e;">"type"</span>: <span style="color: #e9b96e;">"disk"</span>
                        }
                },
                <span style="color: #e9b96e;">"name"</span>: <span style="color: #e9b96e;">"fluent-hamster"</span>,
                <span style="color: #e9b96e;">"status"</span>: <span style="color: #e9b96e;">"Stopped"</span>,
                <span style="color: #e9b96e;">"status_code"</span>: 102,
                <span style="color: #e9b96e;">"last_used_at"</span>: <span style="color: #e9b96e;">"1970-01-01T00:00:00Z"</span>,
                <span style="color: #e9b96e;">"location"</span>: <span style="color: #e9b96e;">"hypercube06"</span>
        }
</pre>
</div></li>
<li><p>
Start Container Operation
</p>
<div class="org-src-container">
<pre class="src src-sh">Starting fluent-hamster
DBUG[01-22|14:13:39] Sending request to LXD                   <span style="color: #fcaf3e;">method</span>=PUT <span style="color: #fcaf3e;">url</span>=https://192.168.0.48:8443/1.0/containers/fluent-hamster/state <span style="color: #fcaf3e;">etag</span>=
DBUG[01-22|14:13:39]
        {
                <span style="color: #e9b96e;">"action"</span>: <span style="color: #e9b96e;">"start"</span>,
                <span style="color: #e9b96e;">"timeout"</span>: -1,
                <span style="color: #e9b96e;">"force"</span>: false,
                <span style="color: #e9b96e;">"stateful"</span>: false
        }
DBUG[01-22|14:13:40] Got operation from LXD
DBUG[01-22|14:13:40]
        {
                <span style="color: #e9b96e;">"id"</span>: <span style="color: #e9b96e;">"46746a23-5873-4755-a0ad-27385370aa39"</span>,
                <span style="color: #e9b96e;">"class"</span>: <span style="color: #e9b96e;">"task"</span>,
                <span style="color: #e9b96e;">"description"</span>: <span style="color: #e9b96e;">"Starting container"</span>,
                <span style="color: #e9b96e;">"created_at"</span>: <span style="color: #e9b96e;">"2019-01-22T06:13:40.232324373Z"</span>,
                <span style="color: #e9b96e;">"updated_at"</span>: <span style="color: #e9b96e;">"2019-01-22T06:13:40.232324373Z"</span>,
                <span style="color: #e9b96e;">"status"</span>: <span style="color: #e9b96e;">"Running"</span>,
                <span style="color: #e9b96e;">"status_code"</span>: 103,
                <span style="color: #e9b96e;">"resources"</span>: {
                        <span style="color: #e9b96e;">"containers"</span>: [
                                <span style="color: #e9b96e;">"/1.0/containers/fluent-hamster"</span>
                        ]
                },
                <span style="color: #e9b96e;">"metadata"</span>: null,
                <span style="color: #e9b96e;">"may_cancel"</span>: false,
                <span style="color: #e9b96e;">"err"</span>: <span style="color: #e9b96e;">""</span>
        }
</pre>
</div></li>
<li><p>
Wait Start Operation Done
</p>
<div class="org-src-container">
<pre class="src src-sh">DBUG[01-22|14:13:40] Sending request to LXD                   <span style="color: #fcaf3e;">method</span>=GET <span style="color: #fcaf3e;">url</span>=https://192.168.0.48:8443/1.0/operations/46746a23-5873-4755-a0ad-27385370aa39 <span style="color: #fcaf3e;">etag</span>=
DBUG[01-22|14:13:42] Got response struct from LXD
DBUG[01-22|14:13:42]
        {
                <span style="color: #e9b96e;">"id"</span>: <span style="color: #e9b96e;">"46746a23-5873-4755-a0ad-27385370aa39"</span>,
                <span style="color: #e9b96e;">"class"</span>: <span style="color: #e9b96e;">"task"</span>,
                <span style="color: #e9b96e;">"description"</span>: <span style="color: #e9b96e;">"Starting container"</span>,
                <span style="color: #e9b96e;">"created_at"</span>: <span style="color: #e9b96e;">"2019-01-22T06:13:40.232324373Z"</span>,
                <span style="color: #e9b96e;">"updated_at"</span>: <span style="color: #e9b96e;">"2019-01-22T06:13:40.232324373Z"</span>,
                <span style="color: #e9b96e;">"status"</span>: <span style="color: #e9b96e;">"Success"</span>,
                <span style="color: #e9b96e;">"status_code"</span>: 200,
                <span style="color: #e9b96e;">"resources"</span>: {
                        <span style="color: #e9b96e;">"containers"</span>: [
                                <span style="color: #e9b96e;">"/1.0/containers/fluent-hamster"</span>
                        ]
                },
                <span style="color: #e9b96e;">"metadata"</span>: null,
                <span style="color: #e9b96e;">"may_cancel"</span>: false,
                <span style="color: #e9b96e;">"err"</span>: <span style="color: #e9b96e;">""</span>
        }
</pre>
</div></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgd0a5b21" class="outline-2">
<h2 id="orgd0a5b21">Ansible</h2>
<div class="outline-text-2" id="text-orgd0a5b21">
</div>
<div id="outline-container-orgc1ee722" class="outline-3">
<h3 id="orgc1ee722">Lxd connection</h3>
<div class="outline-text-3" id="text-orgc1ee722">
<p>
Ansible has a <code>lxd</code> connection, which can be used to manage lxd
containers.
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span style="color: #8cc4ff;">lxdui</span>]
<span style="color: #fcaf3e;">lxdui01 ansible_host</span>=lxdui01
<span style="color: #fcaf3e;">lxdui02 ansible_host</span>=lxdui02
[<span style="color: #8cc4ff;">lxdui:vars</span>]
<span style="color: #fcaf3e;">ansible_user</span>=root
<span style="color: #fcaf3e;">ansible_connection</span>=lxd
</pre>
</div>

<p>
To ping:
</p>
<div class="org-src-container">
<pre class="src src-sh">ansible -m ping lxdui -vvvvv <span style="color: #73d216;">#</span><span style="color: #73d216;">=&gt;</span>

ansible 2.7.6
&lt;lxdui01&gt; ESTABLISH LXD CONNECTION FOR USER: root
&lt;lxdui01&gt; EXEC /bin/sh -c <span style="color: #e9b96e;">'echo ~root &amp;&amp; sleep 0'</span>
&lt;lxdui02&gt; ESTABLISH LXD CONNECTION FOR USER: root
lxdui02 | SUCCESS =&gt; {
    <span style="color: #e9b96e;">"changed"</span>: false,
    <span style="color: #e9b96e;">"invocation"</span>: {
        <span style="color: #e9b96e;">"module_args"</span>: {
            <span style="color: #e9b96e;">"data"</span>: <span style="color: #e9b96e;">"pong"</span>
        }
    },
    <span style="color: #e9b96e;">"ping"</span>: <span style="color: #e9b96e;">"pong"</span>
}
lxdui01 | SUCCESS =&gt; {
    <span style="color: #e9b96e;">"changed"</span>: false,
    <span style="color: #e9b96e;">"invocation"</span>: {
        <span style="color: #e9b96e;">"module_args"</span>: {
            <span style="color: #e9b96e;">"data"</span>: <span style="color: #e9b96e;">"pong"</span>
        }
    },
    <span style="color: #e9b96e;">"ping"</span>: <span style="color: #e9b96e;">"pong"</span>
}
META: ran handlers
META: ran handlers
</pre>
</div>

<p>
It can work without ssh:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #fce94f;">ansible</span> (client) -&gt; lxc (client) -&gt; lxd api(server) -&gt; lxd containers
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
